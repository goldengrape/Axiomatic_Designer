好的，遵照指示。

我将开始执行《项目代办事项列表 (V2.6)》中 `L1-DP8` 下的待办任务：撰写《即时反馈批注 (priority_revisions.md) 数据结构与锚点机制规范》。

本文档旨在详细定义用于捕获用户行内批注的数据格式，并重点阐述《软件用户需求文档 (URD) V1.6》§7.3 中要求的“上下文片段锚点”机制。该机制是确保用户反馈能够被精确应用到可能已发生变化的目标文档中的核心技术。

以下是本次工作的产出文档。

---

### **即时反馈批注 (priority_revisions.md) 数据结构与锚点机制规范 (V1.0)**

**状态:** 草稿 (Draft)

**版本说明:** 本文档 (V1.0) 是该规范的初始版本。它旨在为系统捕获和处理用户即时反馈（行内批注）提供一个标准化的数据结构和一套健壮的定位机制。

#### **1. 引言**

本文档详细定义了 `priority_revisions.md` 文件的数据结构，并阐述了其核心技术——“上下文片段锚点”机制。该文件是用户通过即时反馈接口（如高亮文本并添加评论）进行交互时的直接产物，并作为最高优先级的输入，被 `L1-DP5: 内容生成与修订引擎` 用于下一轮的文档修订。

**设计目标:**
*   **定位健壮性 (Robustness):** 设计的核心目标是解决“文档内容在用户批注后可能发生变化”的问题。单纯依赖行号进行定位是脆弱的，本规范定义的“锚点”机制旨在通过上下文内容匹配，实现对批注位置的健壮追踪。
*   **机器可解析性 (Machine-Parsable):** 文件格式必须是结构化的，以便于 `L1-DP5` 能够确定性地解析每一条批注、其内容以及其精确的意图位置。
*   **可追溯性与原子性 (Traceability & Atomicity):** 每条批注都是一个独立的、可追踪的原子单元，包含作者、评论和定位锚点。

**设计依据:**
*   《软件用户需求文档 (URD) V1.6》 (§ 7.3)
*   《L1-DP8 用户命令与控制 API 接口规范 (V1.0)》 (§ 4.3, § 5.3)
*   《公理设计辅助系统 L2 公理设计文档 (子系统：内容生成与修订引擎) (V1.0)》 (L2-DP2 的职责)

#### **2. 文件格式与数据结构**

为兼顾结构化数据的精确性与 Markdown 生态的通用性，`priority_revisions.md` 文件采用 **Markdown 格式**，其内容由一个 **YAML Front Matter** 块和包含批注数据列表的 **YAML 内容块** 组成。

##### **2.1. YAML Front Matter (元数据)**
此部分包含了整个批注文件的元数据，位于文件顶部，由三条短划线 (`---`) 包围。

| 键 (Key) | 类型 | 是否必需 | 描述 |
| :--- | :--- | :--- | :--- |
| `schemaVersion` | string | 是 | 本批注文件 Schema 的版本号。本文档定义为 "1.0"。 |
| `targetDocumentUri` | string | 是 | 被批注文档的唯一版本化URI。 |
| `generatedAt` | string | 是 | 本文件的生成或最后更新时间戳 (ISO 8601)。 |

##### **2.2. YAML 内容块 (批注列表)**
此部分紧随 Front Matter 之后，包含一个批注对象数组。为确保数据结构的完整性，整个数组被包裹在一个 YAML 代码块中。

```yaml
annotations:
  - # Annotation Object 1
  - # Annotation Object 2
  ...
```

##### **2.3. Annotation Object (批注对象)**
每个批注对象代表用户的一次独立批注操作，包含以下字段：

| 键 (Key) | 类型 | 是否必需 | 描述 |
| :--- | :--- | :--- | :--- |
| `annotationId` | string | 是 | 一个在文件内唯一的批注标识符，便于追踪。 |
| `authorId` | string | 是 | 提交该批注的用户标识符。 |
| `comment` | string | 是 | 用户输入的批注内容/修订指令。 |
| `anchor` | object | 是 | **核心定位机制**，详见第3节。 |
| `status` | string | 是 | 批注的处理状态。枚举值: `PENDING`, `APPLIED`, `STALE`。 |

#### **3. 核心机制：上下文片段锚点 (Contextual Snippet Anchor)**

锚点 (`anchor`) 对象是实现健壮定位的关键。它不依赖于脆弱的行号，而是通过捕获目标文本周围的上下文来“锁定”位置。

##### **3.1. 锚点的数据结构**
`anchor` 对象包含以下三个字段：

| 键 (Key) | 类型 | 是否必需 | 描述 |
| :--- | :--- | :--- | :--- |
| `prefix` | string | 是 | 用户高亮选区**之前**的上下文片段。 |
| `exact` | string | 是 | 用户高亮选区的**精确**文本内容。 |
| `suffix` | string | 是 | 用户高亮选区**之后**的上下文片段。 |

##### **3.2. 锚点机制的两个阶段**

**阶段一：捕获 (Capture Phase)**
此阶段在客户端（如 Web UI）发生，当用户提交一次批注时，由 `L1-DP8` 的 `/api/v1/annotations` 端点接收。

1.  用户在文档中高亮选择一段文本。
2.  客户端代码捕获三个信息：
    *   `exact`: 高亮选区的完整文本。
    *   `prefix`: 从高亮选区开始位置向前截取固定长度（推荐 50 个字符）的文本作为前缀。
    *   `suffix`: 从高亮选区结束位置向后截取固定长度（推荐 50 个字符）的文本作为后缀。
3.  这三部分文本共同构成了 `anchor` 对象，连同用户评论等信息，被发送到 `L1-DP8`。
4.  `L1-DP8` 服务负责将这些批注聚合或更新到 `priority_revisions.md` 文件中。

**阶段二：解析与应用 (Resolution & Application Phase)**
此阶段在服务端发生，当 `L1-DP5` 开始新一轮修订时，由其子模块 `L2-DP2: 上下文聚合器` 负责执行。

1.  `L2-DP2` 解析 `priority_revisions.md` 文件，遍历每一个状态为 `PENDING` 的批注。
2.  对于每个批注，`L2-DP2` 在当前待修订的文档中执行以下定位算法：
    *   **a. 精确匹配 (Exact Match):** 将 `anchor` 的 `prefix` + `exact` + `suffix` 三者拼接，在文档中进行字符串完全匹配。如果找到唯一匹配，则定位成功。这是最高效、最理想的情况。
    *   **b. 模糊匹配 (Fuzzy Match):** 如果精确匹配失败（通常因为文档已被轻微修改），算法进入回退策略：
        *   **核心文本优先:** 在文档中搜索与 `anchor.exact` 内容最相似的位置。可使用字符串相似度算法（如 Levenshtein 距离或 Ratcliff/Obershelp 模式匹配）来计算相似度得分。
        *   **上下文验证:** 在找到的最佳 `exact` 匹配项周围，检查其前缀和后缀是否与 `anchor.prefix` 和 `anchor.suffix` 相似。
        *   **置信度评估:** 综合 `exact`, `prefix`, `suffix` 的匹配得分，计算出一个总体的“定位置信度”。
    *   **c. 决策与标记:**
        *   如果置信度高于预设阈值（如 90%），则认为定位成功。`L2-DP2` 将用户的 `comment` 与定位到的文本片段打包，送入 `L2-DP3` 的 Prompt 上下文中。该批注的 `status` 可被更新为 `APPLIED`。
        *   如果置信度低于阈值，则认为无法安全地定位批注。`L2-DP2` 将放弃应用此批注，并将其 `status` 更新为 `STALE`（失效），同时可以在日志中记录一条警告。

#### **4. 工作流集成**

1.  **生成:** 用户在前端界面进行批注，`L1-DP8` 负责生成或更新 `priority_revisions.md` 文件。
2.  **消费:** `L1-DP5` 在执行“修订”任务时，其内部的 `L2-DP2` 模块会读取该文件，应用锚点机制定位，并将批注指令注入到 LLM 的上下文中。
3.  **生命周期:** `priority_revisions.md` 是一个临时状态文件。在一轮修订成功应用了其中的批注后，系统应将此文件归档（用于审计）并从活动工作目录中移除，以防指令被重复执行。

#### **5. 完整文件示例 (`priority_revisions.md`)**

以下是一个完整的 `priority_revisions.md` 文件示例，其中包含两条待处理的批注。

```markdown
---
schemaVersion: "1.0"
targetDocumentUri: "vcs://project-gamma/docs/AD_L1.md?commit=f4a3b2c1"
generatedAt: "2025-06-08T18:00:00Z"
---

```yaml
annotations:
  - annotationId: "prev-001"
    authorId: "user-architect-01"
    comment: "这个功能需求的定义过于模糊，请明确指出衡量的具体指标是什么？"
    anchor:
      prefix: "我们提炼并定义了以下系统 L1 级功能需求。"
      exact: "FR2: 管理项目级词汇与约束"
      suffix: "定义：系统应维护一个全局性的“项目词汇与约束”文件，包括术语定义、缩写词、命名约定和格式化约束，"
    status: "PENDING"
  - annotationId: "prev-002"
    authorId: "user-architect-01"
    comment: "“纯粹的架构协调组件”这个表述很好，但应该强调它不直接实现任何FR，以避免混淆。"
    anchor:
      prefix: "我们定义了以下L1级设计参数。此外，引入了一个特殊的架构组件DP0，它不直接实现任何FR，而是作为协调器来组织其他DPs的执行流程。"
      exact: "DP0: 工作流与状态控制器 (Workflow & State Controller)"
      suffix: "职责：这是一个纯粹的架构协调组件。其唯一职责是根据系统预设的流程模型（如“撰写-审查-修订”循环），管理系统状态，"
    status: "PENDING"
```

---
Gemini 2.5 Pro 0605 writer